================
 AWS環境の準備
================

CloudFormationを使って自動作成
==============================

以下のハンズオンで必要なAWS IoT以外のサービスについてはCloudFormationを使って自動作成します。CloudFormationはスタックの中にこれらのリソースを作成し、一括して削除などができます。

IAMユーザ
    Edisonで認証に利用する証明書の登録作業を実施する際に使用するユーザ

IAMロール
    AWS IoTやブラウザがAWSサービスにアクセスするために使用するロール

IAMポリシー
    AWS IoTやブラウザが使用する各ロールがどのサービスに、どのような操作を行って良いか定義するポリシー

DynamoDBテーブル
    シナリオ１でセンサーデータを保存するためのテーブル

SNSトピック/サブスクリプション
    シナリオ１でメール通知するためのSNS設定

Lambdaファンクション
    WebブラウザからのリクエストでAWS IoTからデータを取得したり、データを設定するためのファンクション

マネージメントコンソールを開き、右上のリージョン一覧から[米国東部（バージニア北部）]を選択します。

.. image:: images/2-regions-us@2x.png

|

サービス一覧から[Cloud Formation]をクリックして開きます。[Create Stack]をクリックします。

.. image:: images/2-cf-1@2x.png

|

[Select Template]では[Choose a template]で[Specify an Amazon S3 template URL]を選択し、以下のパスを入力し、[Next]をクリックします。

https://s3-ap-northeast-1.amazonaws.com/awsiot-handson-dojo-jp/aws-iot-handson-dojyo-basic.yml

|

.. image:: images/2-cf-2@2x.png

[Specify Details]で[Stack Name]に”AWSIoTHandsonStack-<参加者番号>”と入力し、[AdministratorEmail]にシナリオ１で使用するメールの通知先を入力します。そして[Next]をクリックします。

.. image:: images/2-cf-3@2x.png

|

[Options]で何も入力せずに[Next]をクリックします。

.. image:: images/2-cf-4@2x.png

|

[Review]の画面を下にスクロールし、[Capabilities]で[I acknowledge that this template...]にチェックを入れ、[Create]をクリックします。

.. image:: images/2-cf-5@2x.png

|

Cloud Formationのスタックの一覧に作成したスタックが表示されるのを確認します。Statusが[CREATE_IN_PROGRESS]から[CREATE_COMPLETE]になるのを待ちます。

.. image:: images/2-cf-6@2x.png

|

.. image:: images/2-cf-7@2x.png

|

画面下の[Output]タブを選択し、[Value]の内容を全てメモ帳などにコピーします。

.. image:: images/2-cf-8@2x.png

|

Cognito Identityを手動作成
===========================
シナリオ１，２で使用するWebアプリで匿名認証を行うために使用するCognito Identityを作成します。Cognitoは現時点でCloudFormationに対応していないため、手動で作成します。マネージメントコンソールのサービス一覧から[Cognito]をクリックして開き、[Manage Federated Identities]をクリックします。

.. image:: images/2-cognito-1@2x.png

|

[Create new identity pool]の[Identity pool name]に”AWSIoTHandson <参加者番号>”と入力し、[Enable access to unauthenticated identities]にチェックを入れ、[Create Pool]をクリックします。

.. image:: images/2-cognito-2@2x.png

|

[許可]をクリックします。

.. image:: images/2-cognito-3@2x.png

|

以下のように[Get AWS Credetials]に表示されているIdentity Pool IDをメモ帳などにコピーします。

.. image:: images/2-cognito-4-us@2x.png

|

マネージメントコンソールのサービス一覧から[IAM]を開き、左側のメニューから[ロール]を選択します。ロールの一覧から”Cognito_AWSIoTHandson<参加者番号>Unauth_Role”をクリックします。

.. image:: images/2-cognito-5@2x.png

|

[アクセス許可]のタブを選択し、管理ポリシーの[ポリシーのアタッチ]をクリックします。

.. image:: images/2-cognito-6@2x.png

|

フィルタに”HandsonStack-<参加者番号>”と入力して絞込を行い、表示されたポリシー”AWSIoTHandsonStack-<参加者番号>-WebAppPolicy-<英数字>”を選択し、[ポリシーのアタッチ]をクリックします。

.. image:: images/2-cognito-7@2x.png

|

[管理ポリシー]に”AWSIoTHandsonStack-<参加者番号>-WebAppPolicy-<英数字>”ポリシーが表示されていることを確認します。

.. image:: images/2-cognito-8@2x.png

|
